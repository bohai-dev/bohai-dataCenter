<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bohai.dataCenter.persistence.ReportSpecialReturnMapper" >
  <resultMap id="BaseResultMap" type="com.bohai.dataCenter.entity.ReportSpecialReturn" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 23 15:52:48 CST 2017.
    -->
    <id column="INVESTOR_NO" property="investorNo" jdbcType="VARCHAR" />
    <result column="INVESTOR_NAME" property="investorName" jdbcType="VARCHAR" />
    <result column="MEDIATOR_NO" property="mediatorNo" jdbcType="VARCHAR" />
    <result column="MEDIATOR_NAME" property="mediatorName" jdbcType="VARCHAR" />
    <result column="SREBATE" property="srebate" jdbcType="VARCHAR" />
    <result column="ZREBATE" property="zrebate" jdbcType="VARCHAR" />
    <result column="DREBATE" property="drebate" jdbcType="VARCHAR" />
    <result column="FIX_PROPORTION" property="fixProportion" jdbcType="VARCHAR" />
    <result column="CUSTOM_PROPORTION" property="customProportion" jdbcType="VARCHAR" />
    <result column="AMOUNT" property="amount" jdbcType="VARCHAR" />
    <result column="MONTH" property="month" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 23 15:52:48 CST 2017.
    -->
    INVESTOR_NO, INVESTOR_NAME, MEDIATOR_NO, MEDIATOR_NAME, SREBATE, ZREBATE, DREBATE, 
    FIX_PROPORTION, CUSTOM_PROPORTION, AMOUNT, MONTH
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 23 15:52:48 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from T_REPORT_SPECIAL_RETURN
    where INVESTOR_NO = #{investorNo,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 23 15:52:48 CST 2017.
    -->
    delete from T_REPORT_SPECIAL_RETURN
    where INVESTOR_NO = #{investorNo,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.bohai.dataCenter.entity.ReportSpecialReturn" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 23 15:52:48 CST 2017.
    -->
    insert into T_REPORT_SPECIAL_RETURN (INVESTOR_NO, INVESTOR_NAME, MEDIATOR_NO, 
      MEDIATOR_NAME, SREBATE, ZREBATE, 
      DREBATE, FIX_PROPORTION, CUSTOM_PROPORTION, 
      AMOUNT, MONTH)
    values (#{investorNo,jdbcType=VARCHAR}, #{investorName,jdbcType=VARCHAR}, #{mediatorNo,jdbcType=VARCHAR}, 
      #{mediatorName,jdbcType=VARCHAR}, #{srebate,jdbcType=VARCHAR}, #{zrebate,jdbcType=VARCHAR}, 
      #{drebate,jdbcType=VARCHAR}, #{fixProportion,jdbcType=VARCHAR}, #{customProportion,jdbcType=VARCHAR}, 
      #{amount,jdbcType=VARCHAR}, #{month,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.bohai.dataCenter.entity.ReportSpecialReturn" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 23 15:52:48 CST 2017.
    -->
    insert into T_REPORT_SPECIAL_RETURN
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="investorNo != null" >
        INVESTOR_NO,
      </if>
      <if test="investorName != null" >
        INVESTOR_NAME,
      </if>
      <if test="mediatorNo != null" >
        MEDIATOR_NO,
      </if>
      <if test="mediatorName != null" >
        MEDIATOR_NAME,
      </if>
      <if test="srebate != null" >
        SREBATE,
      </if>
      <if test="zrebate != null" >
        ZREBATE,
      </if>
      <if test="drebate != null" >
        DREBATE,
      </if>
      <if test="fixProportion != null" >
        FIX_PROPORTION,
      </if>
      <if test="customProportion != null" >
        CUSTOM_PROPORTION,
      </if>
      <if test="amount != null" >
        AMOUNT,
      </if>
      <if test="month != null" >
        MONTH,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="investorNo != null" >
        #{investorNo,jdbcType=VARCHAR},
      </if>
      <if test="investorName != null" >
        #{investorName,jdbcType=VARCHAR},
      </if>
      <if test="mediatorNo != null" >
        #{mediatorNo,jdbcType=VARCHAR},
      </if>
      <if test="mediatorName != null" >
        #{mediatorName,jdbcType=VARCHAR},
      </if>
      <if test="srebate != null" >
        #{srebate,jdbcType=VARCHAR},
      </if>
      <if test="zrebate != null" >
        #{zrebate,jdbcType=VARCHAR},
      </if>
      <if test="drebate != null" >
        #{drebate,jdbcType=VARCHAR},
      </if>
      <if test="fixProportion != null" >
        #{fixProportion,jdbcType=VARCHAR},
      </if>
      <if test="customProportion != null" >
        #{customProportion,jdbcType=VARCHAR},
      </if>
      <if test="amount != null" >
        #{amount,jdbcType=VARCHAR},
      </if>
      <if test="month != null" >
        #{month,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.bohai.dataCenter.entity.ReportSpecialReturn" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 23 15:52:48 CST 2017.
    -->
    update T_REPORT_SPECIAL_RETURN
    <set >
      <if test="investorName != null" >
        INVESTOR_NAME = #{investorName,jdbcType=VARCHAR},
      </if>
      <if test="mediatorNo != null" >
        MEDIATOR_NO = #{mediatorNo,jdbcType=VARCHAR},
      </if>
      <if test="mediatorName != null" >
        MEDIATOR_NAME = #{mediatorName,jdbcType=VARCHAR},
      </if>
      <if test="srebate != null" >
        SREBATE = #{srebate,jdbcType=VARCHAR},
      </if>
      <if test="zrebate != null" >
        ZREBATE = #{zrebate,jdbcType=VARCHAR},
      </if>
      <if test="drebate != null" >
        DREBATE = #{drebate,jdbcType=VARCHAR},
      </if>
      <if test="fixProportion != null" >
        FIX_PROPORTION = #{fixProportion,jdbcType=VARCHAR},
      </if>
      <if test="customProportion != null" >
        CUSTOM_PROPORTION = #{customProportion,jdbcType=VARCHAR},
      </if>
      <if test="amount != null" >
        AMOUNT = #{amount,jdbcType=VARCHAR},
      </if>
      <if test="month != null" >
        MONTH = #{month,jdbcType=VARCHAR},
      </if>
    </set>
    where INVESTOR_NO = #{investorNo,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.bohai.dataCenter.entity.ReportSpecialReturn" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Tue May 23 15:52:48 CST 2017.
    -->
    update T_REPORT_SPECIAL_RETURN
    set INVESTOR_NAME = #{investorName,jdbcType=VARCHAR},
      MEDIATOR_NO = #{mediatorNo,jdbcType=VARCHAR},
      MEDIATOR_NAME = #{mediatorName,jdbcType=VARCHAR},
      SREBATE = #{srebate,jdbcType=VARCHAR},
      ZREBATE = #{zrebate,jdbcType=VARCHAR},
      DREBATE = #{drebate,jdbcType=VARCHAR},
      FIX_PROPORTION = #{fixProportion,jdbcType=VARCHAR},
      CUSTOM_PROPORTION = #{customProportion,jdbcType=VARCHAR},
      AMOUNT = #{amount,jdbcType=VARCHAR}
      
    where INVESTOR_NO = #{investorNo,jdbcType=VARCHAR}
    and MONTH = #{month,jdbcType=VARCHAR}
  </update>
  
  <select id="selectByCondition" parameterType="com.bohai.dataCenter.vo.QuerySpecialReturnReportParamVO" resultMap="BaseResultMap">
    select 
    <include refid="Base_Column_List" />
    from T_REPORT_SPECIAL_RETURN
    <where>
        <if test="month != null and month != ''">
            MONTH = #{month,jdbcType=VARCHAR}
        </if>
        <if test="investorNo != null and investorNo != ''">
            INVESTOR_NO = #{investorNo,jdbcType=VARCHAR}
        </if>
        <if test="investorName != null and investorName != ''">
            INVESTOR_NAME = #{investorName,jdbcType=VARCHAR}
        </if>
        <if test="mediatorNo != null and mediatorNo != ''">
            MEDIATOR_NO = #{mediatorNo,jdbcType=VARCHAR}
        </if>
        <if test="mediatorName != null and mediatorName != ''">
            MEDIATOR_NAME = #{mediatorName,jdbcType=VARCHAR}
        </if>
    </where>

  </select>
  
  <select id="selectMarketerReturn" parameterType="java.lang.String" resultType="java.util.Map">
    <!-- select MARKETER_NO,MARKETER_NAME,DEP_NAME, sum(MARKETER_AMOUNT) as MARKETER_AMOUNT
    from (
          select t1.MARKETER_NO,
                  t1.MARKETER_NAME,
                  t1.DEP_NAME,
                  round(
                        case when  t1.DEP_NAME in ('创新业务一部','资产管理业务部','华东事业部一部','上海营业部') then
                            (case when t5.return_type = '1'
                            then 
                                (srebate*(1-t.fix_proportion)+drebate+zrebate)*(1-0.1178/1.06)*0.8
                            else
                              (case when 
                                        t.fix_proportion is not null 
                                   then 
                                        (srebate+drebate+zrebate)*(1-0.1178/1.06)*(1-t.fix_proportion)*0.8
                                        
                                   else 
                                        decode(t.custom_proportion,0,(t.srebate+t.zrebate+t.drebate)*(1-0.1178/1.06)*0.8,(srebate+drebate+zrebate)*(1-0.1178/1.06)*(1-t.custom_proportion)*0.8 )
                                end)
    
                            end)
                        else 
                            (case when t5.return_type = '1'
                              then 
                                  (srebate*(1-t.fix_proportion)+drebate+zrebate)*(1-0.1172/1.06)*0.8
                              else
                                (case when 
                                          t.fix_proportion is not null 
                                     then 
                                          (srebate+drebate+zrebate)*(1-0.1172/1.06)*(1-t.fix_proportion)*0.8
                                          
                                     else 
                                          decode(t.custom_proportion,0,(t.srebate+t.zrebate+t.drebate)*(1-0.1172/1.06)*0.8,(srebate+drebate+zrebate)*(1-0.1172/1.06)*(1-t.custom_proportion)*0.8 )
                                  end)
      
                              end)
                        end
                  ,2) as MARKETER_AMOUNT  
          from T_REPORT_SPECIAL_RETURN t left join T_MARKETER t1  
          on F_GETMARKETERNO(t.INVESTOR_NO) = t1.MARKETER_NO
          left join T_SPECIAL_RETURN t5 
          on t.INVESTOR_NO = t5.INVESTOR_NO
          where t.MONTH = #{month}
          and not EXISTS (select 1 from  MARKET_CUSTTEMP t2,T_MEDIATOR_CUST t3 where t2.CUSTNAME = t3.mediator_name and t3.CUST_NO = t.investor_no and t2.DBL16 = 0 )
          
          union all
          
          select t1.MARKETER_NO,t1.MARKETER_NAME,t1.DEP_NAME,
          case when t1.DEP_NAME in ('创新业务一部','资产管理业务部','华东事业部一部','上海营业部') then round((nvl(t.SREBATE,0)+nvl(t.ZREBATE,0)+nvl(t.DREBATE,0))*(1-0.1178/1.06)*0.8,2) else round((nvl(t.SREBATE,0)+nvl(t.ZREBATE,0)+nvl(t.DREBATE,0))*(1-0.1172/1.06)*0.8,2)  end  as MARKETER_AMOUNT 
          from T_REPORTE_INVESTOR_REBATE t left join T_MARKETER t1  
          on F_GETMARKETERNO(t.INVESTOR_NO) = t1.MARKETER_NO
          where not exists (select 1 
                              from T_REPORT_SPECIAL_RETURN t2 
                              where t.INVESTOR_NO = t2.INVESTOR_NO 
                              and t.MONTH = t2.MONTH)
          and t.MONTH = #{month}
          and not EXISTS (select 1 from  MARKET_CUSTTEMP t2,T_MEDIATOR_CUST t3 where t2.CUSTNAME = t3.mediator_name and t3.CUST_NO = t.investor_no and t2.DBL16 = 0 )
        )
    where MARKETER_NO is not null
    group by MARKETER_NO,MARKETER_NAME,DEP_NAME -->
    
    select MARKETER_NO,MARKETER_NAME,DEP_NAME, sum(MARKETER_AMOUNT) as MARKETER_AMOUNT
    from ( select t1.MARKETER_NO, t1.MARKETER_NAME, F_GETDEPNAME(t.INVESTOR_NO) as DEP_NAME, 
              round( case when F_GETDEPNAME(t.INVESTOR_NO) in ('创新业务部','资产管理业务部','华东事业部一部','上海营业部')
                    then (case when t5.return_type = '1' 
                          then (zrebate*(1-t.fix_proportion)+drebate+srebate)*(1-0.1178/1.06)*0.8 
                          else (case when t.fix_proportion is not null 
                                then (srebate+drebate+zrebate)*(1-0.1178/1.06)*(1-t.fix_proportion)*0.8 
                                else decode(t.custom_proportion,0,(t.srebate+t.zrebate+t.drebate)*(1-0.1178/1.06)*0.8,(srebate+drebate+zrebate)*(1-0.1178/1.06)*(1-t.custom_proportion)*0.8 ) 
                                 end) 
                          end) 
                    else (case when t5.return_type = '1' 
                          then (zrebate*(1-t.fix_proportion)+drebate+srebate)*(1-0.1172/1.06)*0.8 
                          else (case when t.fix_proportion is not null 
                                then (srebate+drebate+zrebate)*(1-0.1172/1.06)*(1-t.fix_proportion)*0.8 
                                else decode(t.custom_proportion,0,(t.srebate+t.zrebate+t.drebate)*(1-0.1172/1.06)*0.8,(srebate+drebate+zrebate)*(1-0.1172/1.06)*(1-t.custom_proportion)*0.8 ) 
                                end) 
                           end) 
                     end ,2) as MARKETER_AMOUNT 
        from T_REPORT_SPECIAL_RETURN t 
        left join T_SPECIAL_RETURN t5 on t.INVESTOR_NO = t5.INVESTOR_NO , T_CRM_MARKETER t1  
        where F_GETMARKETERNO(t.INVESTOR_NO) = t1.MARKETER_NO 
        and t.MONTH = #{month}
        and not EXISTS (select 1 from MARKET_CUSTTEMP t2,T_CRM_CUSTOMER t3,T_CRM_MEDIATOR t4 where t3.BELONG_TYPE = '2' and t4.MEDIATOR_NO = t3.BELONG_TO  and t2.TYPE = '3' and t2.CUSTNAME = t4.MEDIATOR_NAME and t3.INVESTOR_NO = t.investor_no and t2.DBL16 = 0 ) 
        union all 
        select t1.MARKETER_NO,t1.MARKETER_NAME,F_GETDEPNAME(t.INVESTOR_NO) as DEP_NAME, case when F_GETDEPNAME(t.INVESTOR_NO) in ('创新业务部','资产管理业务部','华东事业部一部','上海营业部') then round((nvl(t.SREBATE,0)+nvl(t.ZREBATE,0)+nvl(t.DREBATE,0))*(1-0.1178/1.06)*0.8,2) else round((nvl(t.SREBATE,0)+nvl(t.ZREBATE,0)+nvl(t.DREBATE,0))*(1-0.1172/1.06)*0.8,2) end as MARKETER_AMOUNT 
        from T_REPORTE_INVESTOR_REBATE t , T_CRM_MARKETER t1  
        where F_GETMARKETERNO(t.INVESTOR_NO) = t1.MARKETER_NO 
        and not exists (select 1 from T_REPORT_SPECIAL_RETURN t2 where t.INVESTOR_NO = t2.INVESTOR_NO and t.MONTH = t2.MONTH) 
        and t.MONTH = #{month}
        and not EXISTS (select 1 from MARKET_CUSTTEMP t2,T_CRM_CUSTOMER t3,T_CRM_MEDIATOR t4 where t3.BELONG_TYPE = '2' and t4.MEDIATOR_NO = t3.BELONG_TO  and t2.TYPE = '3' and t2.CUSTNAME = t4.MEDIATOR_NAME and t3.INVESTOR_NO = t.investor_no and t2.DBL16 = 0) ) 
    group by MARKETER_NO,MARKETER_NAME,DEP_NAME
    
  </select>
</mapper>