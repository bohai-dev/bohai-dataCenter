<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bohai.dataCenter.persistence.CapitalStatementMapper" >
  <resultMap id="BaseResultMap" type="com.bohai.dataCenter.entity.CapitalStatement" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 10 09:25:39 CST 2017.
    -->
    <id column="ID" property="id" jdbcType="VARCHAR" />
    <result column="TRADE_DATE_STR" property="tradeDateStr" jdbcType="VARCHAR" />
    <result column="TRADE_DATE" property="tradeDate" jdbcType="TIMESTAMP" />
    <result column="INVESTOR_NO" property="investorNo" jdbcType="VARCHAR" />
    <result column="INVESTOR_NAME" property="investorName" jdbcType="VARCHAR" />
    <result column="DEPT_CODE" property="deptCode" jdbcType="VARCHAR" />
    <result column="DEPT_NAME" property="deptName" jdbcType="VARCHAR" />
    <result column="AVAILABLE_FUNDS" property="availableFunds" jdbcType="VARCHAR" />
    <result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
    <result column="UPDATE_TIME" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="CREATE_BY" property="createBy" jdbcType="VARCHAR" />
    <result column="UPDATE_BY" property="updateBy" jdbcType="VARCHAR" />
    <result column="INVESTOR_RIGHTS" property="investorRights" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 10 09:25:39 CST 2017.
    -->
    ID, TRADE_DATE_STR, TRADE_DATE, INVESTOR_NO, INVESTOR_NAME, DEPT_CODE, DEPT_NAME, 
    AVAILABLE_FUNDS, CREATE_TIME, UPDATE_TIME, CREATE_BY, UPDATE_BY, INVESTOR_RIGHTS
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 10 09:25:39 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from T_CAPITAL_STATEMENT
    where ID = #{id,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 10 09:25:39 CST 2017.
    -->
    delete from T_CAPITAL_STATEMENT
    where ID = #{id,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.bohai.dataCenter.entity.CapitalStatement" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 10 09:25:39 CST 2017.
    -->
    insert into T_CAPITAL_STATEMENT (ID, TRADE_DATE_STR, TRADE_DATE, 
      INVESTOR_NO, INVESTOR_NAME, DEPT_CODE, 
      DEPT_NAME, AVAILABLE_FUNDS, CREATE_TIME, 
      UPDATE_TIME, CREATE_BY, UPDATE_BY, 
      INVESTOR_RIGHTS)
    values (#{id,jdbcType=VARCHAR}, #{tradeDateStr,jdbcType=VARCHAR}, #{tradeDate,jdbcType=TIMESTAMP}, 
      #{investorNo,jdbcType=VARCHAR}, #{investorName,jdbcType=VARCHAR}, #{deptCode,jdbcType=VARCHAR}, 
      #{deptName,jdbcType=VARCHAR}, #{availableFunds,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, 
      #{updateTime,jdbcType=TIMESTAMP}, #{createBy,jdbcType=VARCHAR}, #{updateBy,jdbcType=VARCHAR}, 
      #{investorRights,jdbcType=VARCHAR})
  </insert>
  <insert id="insertSelective" parameterType="com.bohai.dataCenter.entity.CapitalStatement" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 10 09:25:39 CST 2017.
    -->
    insert into T_CAPITAL_STATEMENT
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        ID,
      </if>
      <if test="tradeDateStr != null" >
        TRADE_DATE_STR,
      </if>
      <if test="tradeDate != null" >
        TRADE_DATE,
      </if>
      <if test="investorNo != null" >
        INVESTOR_NO,
      </if>
      <if test="investorName != null" >
        INVESTOR_NAME,
      </if>
      <if test="deptCode != null" >
        DEPT_CODE,
      </if>
      <if test="deptName != null" >
        DEPT_NAME,
      </if>
      <if test="availableFunds != null" >
        AVAILABLE_FUNDS,
      </if>
      <if test="createTime != null" >
        CREATE_TIME,
      </if>
      <if test="updateTime != null" >
        UPDATE_TIME,
      </if>
      <if test="createBy != null" >
        CREATE_BY,
      </if>
      <if test="updateBy != null" >
        UPDATE_BY,
      </if>
      <if test="investorRights != null" >
        INVESTOR_RIGHTS,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=VARCHAR},
      </if>
      <if test="tradeDateStr != null" >
        #{tradeDateStr,jdbcType=VARCHAR},
      </if>
      <if test="tradeDate != null" >
        #{tradeDate,jdbcType=TIMESTAMP},
      </if>
      <if test="investorNo != null" >
        #{investorNo,jdbcType=VARCHAR},
      </if>
      <if test="investorName != null" >
        #{investorName,jdbcType=VARCHAR},
      </if>
      <if test="deptCode != null" >
        #{deptCode,jdbcType=VARCHAR},
      </if>
      <if test="deptName != null" >
        #{deptName,jdbcType=VARCHAR},
      </if>
      <if test="availableFunds != null" >
        #{availableFunds,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null" >
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createBy != null" >
        #{createBy,jdbcType=VARCHAR},
      </if>
      <if test="updateBy != null" >
        #{updateBy,jdbcType=VARCHAR},
      </if>
      <if test="investorRights != null" >
        #{investorRights,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.bohai.dataCenter.entity.CapitalStatement" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 10 09:25:39 CST 2017.
    -->
    update T_CAPITAL_STATEMENT
    <set >
      <if test="tradeDateStr != null" >
        TRADE_DATE_STR = #{tradeDateStr,jdbcType=VARCHAR},
      </if>
      <if test="tradeDate != null" >
        TRADE_DATE = #{tradeDate,jdbcType=TIMESTAMP},
      </if>
      <if test="investorNo != null" >
        INVESTOR_NO = #{investorNo,jdbcType=VARCHAR},
      </if>
      <if test="investorName != null" >
        INVESTOR_NAME = #{investorName,jdbcType=VARCHAR},
      </if>
      <if test="deptCode != null" >
        DEPT_CODE = #{deptCode,jdbcType=VARCHAR},
      </if>
      <if test="deptName != null" >
        DEPT_NAME = #{deptName,jdbcType=VARCHAR},
      </if>
      <if test="availableFunds != null" >
        AVAILABLE_FUNDS = #{availableFunds,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        CREATE_TIME = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateTime != null" >
        UPDATE_TIME = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="createBy != null" >
        CREATE_BY = #{createBy,jdbcType=VARCHAR},
      </if>
      <if test="updateBy != null" >
        UPDATE_BY = #{updateBy,jdbcType=VARCHAR},
      </if>
      <if test="investorRights != null" >
        INVESTOR_RIGHTS = #{investorRights,jdbcType=VARCHAR},
      </if>
    </set>
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.bohai.dataCenter.entity.CapitalStatement" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 10 09:25:39 CST 2017.
    -->
    update T_CAPITAL_STATEMENT
    set TRADE_DATE_STR = #{tradeDateStr,jdbcType=VARCHAR},
      TRADE_DATE = #{tradeDate,jdbcType=TIMESTAMP},
      INVESTOR_NO = #{investorNo,jdbcType=VARCHAR},
      INVESTOR_NAME = #{investorName,jdbcType=VARCHAR},
      DEPT_CODE = #{deptCode,jdbcType=VARCHAR},
      DEPT_NAME = #{deptName,jdbcType=VARCHAR},
      AVAILABLE_FUNDS = #{availableFunds,jdbcType=VARCHAR},
      CREATE_TIME = #{createTime,jdbcType=TIMESTAMP},
      UPDATE_TIME = #{updateTime,jdbcType=TIMESTAMP},
      CREATE_BY = #{createBy,jdbcType=VARCHAR},
      UPDATE_BY = #{updateBy,jdbcType=VARCHAR},
      INVESTOR_RIGHTS = #{investorRights,jdbcType=VARCHAR}
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  
  <select id="selectByTradeDateAndInvestorNo" resultMap="BaseResultMap" parameterType="java.lang.String" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Apr 06 15:48:30 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from T_CAPITAL_STATEMENT
    where TRADE_DATE_STR = #{0,jdbcType=VARCHAR}
    and INVESTOR_NO = #{1,jdbcType=VARCHAR}
  </select>
  
  <select id="selectByMediatorNo" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
     t.ID,t.TRADE_DATE_STR,t.TRADE_DATE,t.INVESTOR_NO,t.INVESTOR_NAME,t.DEPT_CODE,F_GETDEPNAME(t.INVESTOR_NO) as DEPT_NAME,t.AVAILABLE_FUNDS,t.CREATE_TIME,t.UPDATE_TIME,t.CREATE_BY,t.UPDATE_BY,
     (select round(avg(INVESTOR_RIGHTS),2)
        from T_CAPITAL_STATEMENT t2 
        where t.INVESTOR_NO = t2.INVESTOR_NO 
        and to_char(t2.TRADE_DATE,'yyyy')= #{1}
        and to_char(t2.TRADE_DATE,'mm') = #{2}
        ) as INVESTOR_RIGHTS
    from T_CAPITAL_STATEMENT t ,T_CRM_CUSTOMER t1
    where t.INVESTOR_NO = t1.INVESTOR_NO
    and t1.BELONG_TYPE = '2'
    and t1.BELONG_TO = #{0,jdbcType=VARCHAR}
    and to_char(t.TRADE_DATE,'yyyy') = #{1}
    and to_char(t.TRADE_DATE,'mm') = #{2}
  </select>
  
  <select id="selectByInvestorNo" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    ID,TRADE_DATE_STR,TRADE_DATE,INVESTOR_NO,INVESTOR_NAME,DEPT_CODE,F_GETDEPNAME(t.INVESTOR_NO) as DEPT_NAME,AVAILABLE_FUNDS,CREATE_TIME,UPDATE_TIME,CREATE_BY,UPDATE_BY,
     (select round(avg(INVESTOR_RIGHTS),2)
        from T_CAPITAL_STATEMENT t2 
        where t.INVESTOR_NO = t2.INVESTOR_NO 
        and to_char(t2.TRADE_DATE,'yyyy')= #{1}
        and to_char(t2.TRADE_DATE,'mm') = #{2}
      ) as INVESTOR_RIGHTS
    from T_CAPITAL_STATEMENT t
    where INVESTOR_NO = #{0,jdbcType=VARCHAR}
    and to_char(TRADE_DATE,'yyyy') = #{1}
    and to_char(TRADE_DATE,'mm') = #{2}
  </select>
  
  <select id="callInterestReport" parameterType="java.lang.String" statementType="CALLABLE">
    
    call p_report_interest(#{month,jdbcType=VARCHAR})
  
  </select>
  
  <select id="selectRightByMediator" parameterType="com.bohai.dataCenter.vo.QueryMediatorRightParamVO" 
        resultType="java.math.BigDecimal">
    select sum (rights) from (select t.INVESTOR_NO,avg(t.INVESTOR_RIGHTS) as rights
	from T_CAPITAL_STATEMENT t 
	where EXISTS (select 1 from T_CRM_CUSTOMER t1 ,t_CRM_MEDIATOR t2
	               <where>
	                   t1.BELONG_TO = t2.MEDIATOR_NO
	                   and t.INVESTOR_NO = t1.INVESTOR_NO
	                   and t1.BELONG_TYPE = '2'
	                  <if test="mediatorNo != null and mediatorNo != ''" >
	                    and t1.BELONG_TO = #{mediatorNo,jdbcType=VARCHAR}
	                  </if>
	                  <if test="mediatorName != null and mediatorName != ''" >
                        and t2.MEDIATOR_NAME = #{mediatorName,jdbcType=VARCHAR}
                      </if>
	               </where>
	               
	              )
	and to_char(TRADE_DATE,'yyyy') = #{year,jdbcType=VARCHAR}
    and to_char(TRADE_DATE,'mm') = #{month,jdbcType=VARCHAR}
	group by t.INVESTOR_NO) 
  
  </select>
  
  <select id="selectByExistsMarketer" parameterType="java.lang.String" resultType="java.util.Map">
    select t2.MARKETER_NO,t2.MARKETER_NAME,F_GETDEPNAME(t.INVESTOR_NO) as DEP_NAME, t.* 
    from T_CAPITAL_STATEMENT t,T_CRM_MARKETER t2
	where F_GETMARKETERNO(t.INVESTOR_NO) = t2.MARKETER_NO
	and substr(t.TRADE_DATE_STR,0,6) = #{0,jdbcType=VARCHAR}
	and not EXISTS (select 1 from T_REPORT_REBATE t3
	                where t.INVESTOR_NO = t3.INVESTOR_NO
	                and substr(t3.TRADE_DATE_STR,0,6) = #{0,jdbcType=VARCHAR})
  </select>
  
  
</mapper>